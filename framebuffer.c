// #include "framebuffer.h"
// #include <stdint.h>

// #define WIDTH  1024
// #define HEIGHT 768

// static volatile uint32_t* fb = 0;
// static int fb_x = 0, fb_y = 0;
// static uint32_t fb_color = COLOR_WHITE;

// // 8x8 font for ASCII 0x20-0x7E (from font8x8_basic)
// static const uint8_t font8x8_basic[95][8] = {
//     { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 }, // ' '
//     { 0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00 }, // !
//     { 0x6C,0x6C,0x24,0x00,0x00,0x00,0x00,0x00 }, // "
//     { 0x6C,0x6C,0xFE,0x6C,0xFE,0x6C,0x6C,0x00 }, // #
//     { 0x18,0x3E,0x60,0x3C,0x06,0x7C,0x18,0x00 }, // $
//     { 0x00,0xC6,0xCC,0x18,0x30,0x66,0xC6,0x00 }, // %
//     { 0x38,0x6C,0x38,0x76,0xDC,0xCC,0x76,0x00 }, // &
//     { 0x30,0x30,0x60,0x00,0x00,0x00,0x00,0x00 }, // '
//     { 0x0C,0x18,0x30,0x30,0x30,0x18,0x0C,0x00 }, // (
//     { 0x30,0x18,0x0C,0x0C,0x0C,0x18,0x30,0x00 }, // )
//     { 0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00 }, // *
//     { 0x00,0x18,0x18,0x7E,0x18,0x18,0x00,0x00 }, // +
//     { 0x00,0x00,0x00,0x00,0x18,0x18,0x30,0x00 }, // ,
//     { 0x00,0x00,0x00,0x7E,0x00,0x00,0x00,0x00 }, // -
//     { 0x00,0x00,0x00,0x00,0x00,0x18,0x18,0x00 }, // .
//     { 0x06,0x0C,0x18,0x30,0x60,0xC0,0x80,0x00 }, // /
//     { 0x7C,0xC6,0xCE,0xD6,0xE6,0xC6,0x7C,0x00 }, // 0
//     { 0x18,0x38,0x18,0x18,0x18,0x18,0x7E,0x00 }, // 1
//     { 0x3C,0x66,0x06,0x0C,0x30,0x60,0x7E,0x00 }, // 2
//     { 0x3C,0x66,0x06,0x1C,0x06,0x66,0x3C,0x00 }, // 3
//     { 0x1C,0x3C,0x6C,0xCC,0xFE,0x0C,0x1E,0x00 }, // 4
//     { 0x7E,0x60,0x7C,0x06,0x06,0x66,0x3C,0x00 }, // 5
//     { 0x3C,0x66,0x60,0x7C,0x66,0x66,0x3C,0x00 }, // 6
//     { 0x7E,0x66,0x0C,0x18,0x30,0x30,0x30,0x00 }, // 7
//     { 0x3C,0x66,0x66,0x3C,0x66,0x66,0x3C,0x00 }, // 8
//     { 0x3C,0x66,0x66,0x3E,0x06,0x66,0x3C,0x00 }, // 9
//     { 0x00,0x18,0x18,0x00,0x00,0x18,0x18,0x00 }, // :
//     { 0x00,0x18,0x18,0x00,0x18,0x18,0x30,0x00 }, // ;
//     { 0x0C,0x18,0x30,0x60,0x30,0x18,0x0C,0x00 }, // <
//     { 0x00,0x00,0x7E,0x00,0x00,0x7E,0x00,0x00 }, // =
//     { 0x30,0x18,0x0C,0x06,0x0C,0x18,0x30,0x00 }, // >
//     { 0x3C,0x66,0x06,0x1C,0x18,0x00,0x18,0x00 }, // ?
//     { 0x7C,0xC6,0xDE,0xDE,0xDE,0xC0,0x78,0x00 }, // @
//     { 0x18,0x3C,0x66,0x66,0x7E,0x66,0x66,0x00 }, // A
//     { 0x7C,0x66,0x66,0x7C,0x66,0x66,0x7C,0x00 }, // B
//     { 0x3C,0x66,0x60,0x60,0x60,0x66,0x3C,0x00 }, // C
//     { 0x78,0x6C,0x66,0x66,0x66,0x6C,0x78,0x00 }, // D
//     { 0x7E,0x60,0x60,0x7C,0x60,0x60,0x7E,0x00 }, // E
//     { 0x7E,0x60,0x60,0x7C,0x60,0x60,0x60,0x00 }, // F
//     { 0x3C,0x66,0x60,0x6E,0x66,0x66,0x3C,0x00 }, // G
//     { 0x66,0x66,0x66,0x7E,0x66,0x66,0x66,0x00 }, // H
//     { 0x3C,0x18,0x18,0x18,0x18,0x18,0x3C,0x00 }, // I
//     { 0x1E,0x0C,0x0C,0x0C,0x0C,0x6C,0x38,0x00 }, // J
//     { 0x66,0x6C,0x78,0x70,0x78,0x6C,0x66,0x00 }, // K
//     { 0x60,0x60,0x60,0x60,0x60,0x60,0x7E,0x00 }, // L
//     { 0xC6,0xEE,0xFE,0xFE,0xD6,0xC6,0xC6,0x00 }, // M
//     { 0x66,0x76,0x7E,0x7E,0x6E,0x66,0x66,0x00 }, // N
//     { 0x3C,0x66,0x66,0x66,0x66,0x66,0x3C,0x00 }, // O
//     { 0x7C,0x66,0x66,0x7C,0x60,0x60,0x60,0x00 }, // P
//     { 0x3C,0x66,0x66,0x66,0x6E,0x3C,0x0E,0x00 }, // Q
//     { 0x7C,0x66,0x66,0x7C,0x78,0x6C,0x66,0x00 }, // R
//     { 0x3C,0x66,0x30,0x18,0x0C,0x66,0x3C,0x00 }, // S
//     { 0x7E,0x7E,0x5A,0x18,0x18,0x18,0x3C,0x00 }, // T
//     { 0x66,0x66,0x66,0x66,0x66,0x66,0x3C,0x00 }, // U
//     { 0x66,0x66,0x66,0x66,0x66,0x3C,0x18,0x00 }, // V
//     { 0xC6,0xC6,0xC6,0xD6,0xFE,0xEE,0xC6,0x00 }, // W
//     { 0x66,0x66,0x3C,0x18,0x3C,0x66,0x66,0x00 }, // X
//     { 0x66,0x66,0x66,0x3C,0x18,0x18,0x3C,0x00 }, // Y
//     { 0x7E,0x06,0x0C,0x18,0x30,0x60,0x7E,0x00 }, // Z
//     { 0x3C,0x30,0x30,0x30,0x30,0x30,0x3C,0x00 }, // [
//     { 0xC0,0x60,0x30,0x18,0x0C,0x06,0x02,0x00 }, // backslash
//     { 0x3C,0x0C,0x0C,0x0C,0x0C,0x0C,0x3C,0x00 }, // ]
//     { 0x10,0x38,0x6C,0xC6,0x00,0x00,0x00,0x00 }, // ^
//     { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF }, // _
//     { 0x18,0x18,0x0C,0x00,0x00,0x00,0x00,0x00 }, // `
//     { 0x00,0x00,0x3C,0x06,0x3E,0x66,0x3E,0x00 }, // a
//     { 0x60,0x60,0x7C,0x66,0x66,0x66,0x7C,0x00 }, // b
//     { 0x00,0x00,0x3C,0x66,0x60,0x66,0x3C,0x00 }, // c
//     { 0x06,0x06,0x3E,0x66,0x66,0x66,0x3E,0x00 }, // d
//     { 0x00,0x00,0x3C,0x66,0x7E,0x60,0x3C,0x00 }, // e
//     { 0x1C,0x36,0x30,0x7C,0x30,0x30,0x78,0x00 }, // f
//     { 0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x7C }, // g
//     { 0x60,0x60,0x7C,0x66,0x66,0x66,0x66,0x00 }, // h
//     { 0x18,0x00,0x38,0x18,0x18,0x18,0x3C,0x00 }, // i
//     { 0x0C,0x00,0x1C,0x0C,0x0C,0x0C,0x0C,0x78 }, // j
//     { 0x60,0x60,0x66,0x6C,0x78,0x6C,0x66,0x00 }, // k
//     { 0x38,0x18,0x18,0x18,0x18,0x18,0x3C,0x00 }, // l
//     { 0x00,0x00,0x6C,0xFE,0xFE,0xD6,0xC6,0x00 }, // m
//     { 0x00,0x00,0x7C,0x66,0x66,0x66,0x66,0x00 }, // n
//     { 0x00,0x00,0x3C,0x66,0x66,0x66,0x3C,0x00 }, // o
//     { 0x00,0x00,0x7C,0x66,0x66,0x7C,0x60,0x60 }, // p
//     { 0x00,0x00,0x3E,0x66,0x66,0x3E,0x06,0x06 }, // q
//     { 0x00,0x00,0x7C,0x66,0x60,0x60,0x60,0x00 }, // r
//     { 0x00,0x00,0x3E,0x60,0x3C,0x06,0x7C,0x00 }, // s
//     { 0x30,0x30,0x7C,0x30,0x30,0x36,0x1C,0x00 }, // t
//     { 0x00,0x00,0x66,0x66,0x66,0x66,0x3E,0x00 }, // u
//     { 0x00,0x00,0x66,0x66,0x66,0x3C,0x18,0x00 }, // v
//     { 0x00,0x00,0xC6,0xD6,0xFE,0xFE,0x6C,0x00 }, // w
//     { 0x00,0x00,0x66,0x3C,0x18,0x3C,0x66,0x00 }, // x
//     { 0x00,0x00,0x66,0x66,0x66,0x3E,0x06,0x7C }, // y
//     { 0x00,0x00,0x7E,0x0C,0x18,0x30,0x7E,0x00 }, // z
//     { 0x0E,0x18,0x18,0x70,0x18,0x18,0x0E,0x00 }, // {
//     { 0x18,0x18,0x18,0x00,0x18,0x18,0x18,0x00 }, // |
//     { 0x70,0x18,0x18,0x0E,0x18,0x18,0x70,0x00 }, // }
//     { 0x76,0xDC,0x00,0x00,0x00,0x00,0x00,0x00 }, // ~
// };

// static void draw_char(int x, int y, char c, uint32_t color) {
//     // ASCII 0x20 (' ') to 0x7E ('~')
//     if ((unsigned char)c < 0x20 || (unsigned char)c > 0x7E) c = 0x20; // Render non-ascii as space
//     const uint8_t *chr = font8x8_basic[((unsigned char)c) - 0x20];
//     for (int row=0; row<8; ++row) {
//         uint8_t line = chr[row];
//         for (int col=0; col<8; ++col) {
//             if (line & (1 << col)) {
//                 int px = x + (7-col);
//                 int py = y + row;
//                 if (px < WIDTH && py < HEIGHT)
//                     fb[py*WIDTH + px] = color;
//             }
//         }
//     }
// }

// int fb_init() {
//     // Default framebuffer on Pi 3/QEMU: You may need to set up mailbox for real hardware/project
//     fb = (uint32_t*)(0x3F000000 + 0x200000); // Adjust as needed for your Pi model/project
//     return 0; // Always success for this demo
// }

// void fb_set_color(uint32_t color) {
//     fb_color = color;
// }

// void fb_set_pos(int x, int y) {
//     fb_x = x;
//     fb_y = y;
// }

// void fb_print(const char* s) {
//     while (*s) {
//         if (*s == '\n') {
//             fb_x = 0;
//             fb_y += 10;
//         } else {
//             draw_char(fb_x, fb_y, *s, fb_color);
//             fb_x += 8;
//             if (fb_x >= WIDTH) {
//                 fb_x = 0;
//                 fb_y += 10;
//             }
//         }
//         ++s;
//     }
// }

// void fb_println(const char* s) {
//     fb_print(s);
//     fb_print("\n");
// }

#include "framebuffer.h"
#include "mailbox.h"
#include <stdint.h>

#define FB_WIDTH   640
#define FB_HEIGHT  480
#define FB_DEPTH   32

static volatile uint32_t* fb = 0;
static int screen_width  = FB_WIDTH;
static int screen_height = FB_HEIGHT;
static int pitch         = 0;
static int fb_x = 0, fb_y = 0;
static uint32_t fb_color = COLOR_WHITE;

// 8x8 font for ASCII 0x20-0x7E (from font8x8_basic)â€”add your full table here!
static const uint8_t font8x8_basic[95][8] = {
    // ... [full font table as in previous messages] ...
    { 0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00 }, // ' '
    // (Table omitted for brevity, please copy full font here from prior message)
};

static void draw_char(int x, int y, char c, uint32_t color) {
    if ((unsigned char)c < 0x20 || (unsigned char)c > 0x7E) c = 0x20;
    const uint8_t *chr = font8x8_basic[((unsigned char)c) - 0x20];
    for (int row=0; row<8; ++row) {
        uint8_t line = chr[row];
        for (int col=0; col<8; ++col) {
            if (line & (1 << col)) {
                int px = x + (7-col);
                int py = y + row;
                if (px < screen_width && py < screen_height && fb)
                    ((uint32_t*)fb)[py * (pitch/4) + px] = color;
            }
        }
    }
}

int fb_init() {
    uint32_t fb_base = 0, fb_size = 0, fb_pitch = 0;
    if (!fb_mailbox_init(FB_WIDTH, FB_HEIGHT, FB_DEPTH, &fb_base, &fb_size, &fb_pitch))
        return 1;
    fb = (volatile uint32_t*)((uintptr_t)fb_base);
    pitch = fb_pitch;
    // Optionally clear screen
    for (int y = 0; y < FB_HEIGHT; ++y)
        for (int x = 0; x < FB_WIDTH; ++x)
            ((uint32_t*)fb)[y * (pitch/4) + x] = COLOR_BLACK;
    return 0;
}

void fb_set_color(uint32_t color) {
    fb_color = color;
}

void fb_set_pos(int x, int y) {
    fb_x = x;
    fb_y = y;
}

void fb_print(const char* s) {
    while (*s) {
        if (*s == '\n') {
            fb_x = 0;
            fb_y += 10;
        } else {
            draw_char(fb_x, fb_y, *s, fb_color);
            fb_x += 8;
            if (fb_x >= screen_width) {
                fb_x = 0;
                fb_y += 10;
            }
        }
        ++s;
    }
}

void fb_println(const char* s) {
    fb_print(s);
    fb_print("\n");
}